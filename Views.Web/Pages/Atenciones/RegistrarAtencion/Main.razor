@page "/RegistrarAtencion"
@using Models.Entity.Models
@using Logic
@inject IJSRuntime JSRuntime
@using System.Linq
@using Models.Entity.Data


<h1>Registrar Atenciones</h1>

<div class="container mt-4">
    @foreach (var atencion in Atenciones)
    {
        <Tarjeta Atencion="atencion" OnAddService="(args) => OnAddService(args.Item1, args.Item2)" />
    }
</div>

@code {
    private List<InfoAtencionesRealizadas> Atenciones { get; set; } = new List<InfoAtencionesRealizadas>();

    protected override async Task OnInitializedAsync()
    {
        await cargarAtenciones();
    }

    private async Task cargarAtenciones()
    {
        Atenciones = await AtencionLogic.GetAllInfoAtencionesRealizadas();
    }


    private async void OnAddService(int idAtencion, Servicio servicio)
    {
        var atencion = Atenciones.FirstOrDefault(a => a.AtencionId == idAtencion);
        if (atencion != null && !atencion.Servicios.Contains(servicio))
        {
            AtencionPatchDTO atencionPatch = new AtencionPatchDTO();
            atencionPatch.ServicioId = servicio.ServicioId;
            
            await Logic.AtencionLogic.ActualizarAtencion(atencion.AtencionId,atencionPatch);
            Console.WriteLine("Se agregó un servicio a la atencion",servicio.Nombre);
        }
    }

    // private void SaveObservations(int idAtencion, string observations)
    // {
    //     var shift = Atenciones.FirstOrDefault(s => s.Id == idAtencion);
    //     if (shift != null)
    //     {
    //         shift.Observations = observations;
    //     }
    // }
}
